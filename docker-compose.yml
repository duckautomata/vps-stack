services:
  caddy:
    image: caddy:alpine
    restart: unless-stopped
    ports:
      - "443:443"
      - "443:443/udp"
    volumes:
      - ./config/Caddyfile:/etc/caddy/Caddyfile:Z
      - ./certs:/certs:ro,Z
      - caddy_data:/data
    networks:
      - stack-net

  api:
    image: duckautomata/live-transcript-server:latest
    restart: always
    ports:
      - "8080:8080" # used to directly connect to the API for uploading media so we don't go through Cloudflare.
    volumes:
      - ./config/live-transcript.yaml:/app/config.yaml:ro,Z
      - ./data/api:/app/tmp:Z
    networks:
      - stack-net

  archive:
    image: duckautomata/archived-transcript-server:latest
    restart: always
    volumes:
      - ./config/archived-transcript.yaml:/app/config.yaml:ro,Z
      - ./data/archive:/app/tmp:Z
    networks:
      - stack-net

  prometheus:
    image: prom/prometheus
    restart: unless-stopped
    volumes:
      - ./config/prometheus.yml:/etc/prometheus/prometheus.yml:Z
      - ./data/prometheus:/prometheus:Z
    networks:
      - stack-net

  grafana:
    image: grafana/grafana
    restart: unless-stopped
    volumes:
      - ./data/grafana:/var/lib/grafana:Z
      - ./config/grafana_datasources.yaml:/etc/grafana/provisioning/datasources/datasources.yaml:Z
    environment:
      - GF_SERVER_ROOT_URL=https://grafana.duck-automata.com/
    networks:
      - stack-net

  portainer:
    image: portainer/portainer-ce:latest
    restart: always
    command: -H unix:///bitnami/docker/docker.sock
    volumes:
      - /run/user/${UID}/docker.sock:/bitnami/docker/docker.sock:Z
      - ./data/portainer:/data:Z
    networks:
      - stack-net

  loki:
    image: grafana/loki:latest
    restart: unless-stopped
    volumes:
      - ./config/loki.yaml:/etc/loki/local-config.yaml:Z
    networks:
      - stack-net

  promtail:
    image: grafana/promtail:latest
    restart: unless-stopped
    volumes:
      - ./config/promtail.yaml:/etc/promtail/config.yml:Z
      - ./data/api:/var/log/api:ro,Z
      - ./data/archive:/var/log/archive:ro,Z
      - promtail_data:/etc/promtail
    networks:
      - stack-net


  postgres:
    image: postgres:16
    restart: always
    volumes:
      - postgres_data:/var/lib/postgresql/data
    environment:
      POSTGRES_USER: directus
      POSTGRES_PASSWORD: "secure_password_here"
      POSTGRES_DB: directus
    networks:
      - stack-net

  redis:
    image: redis:7
    restart: always
    networks:
      - stack-net

  directus:
    image: directus/directus:latest
    restart: always
    ports:
      - 8055:8055
    depends_on:
      - postgres
      - redis
    environment:
      KEY: "generate-a-random-uuid-here"
      SECRET: "generate-another-random-uuid"
      PUBLIC_URL: "https://directus.duck-automata.com"
      
      # Database
      DB_CLIENT: "pg"
      DB_HOST: "postgres"
      DB_PORT: "5432"
      DB_DATABASE: "directus"
      DB_USER: "directus"
      DB_PASSWORD: "secure_password_here"
      
      # Cache
      CACHE_ENABLED: "true"
      CACHE_STORE: "redis"
      CACHE_REDIS: "redis://redis:6379"
      
      # Admin
      ADMIN_EMAIL: "admin@example.com"
      ADMIN_PASSWORD: "password"
      
      # Storage (R2)
      STORAGE_LOCATIONS: "r2"
      STORAGE_R2_DRIVER: "s3"
      STORAGE_R2_KEY: "replace_with_access_key_id"
      STORAGE_R2_SECRET: "replace_with_secret_access_key"
      STORAGE_R2_BUCKET: "cms-assets"
      STORAGE_R2_REGION: "auto"
      STORAGE_R2_ENDPOINT: "https://<account_id>.r2.cloudflarestorage.com"
      # This allows Directus to generate public URLs pointing to your custom R2 domain
      STORAGE_R2_PUBLIC_URL: "https://content.duck-automata.com"
      
      # CORS
      CORS_ENABLED: "true"
      CORS_ORIGIN: "https://www.duck-automata.com,http://localhost:5173,http://localhost:4173,http://localhost:3000"

    networks:
      - stack-net

volumes:
  caddy_data:
  promtail_data:
  postgres_data:

networks:
  stack-net:
    driver: bridge
